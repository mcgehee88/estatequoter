<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EstateQuoter Pro â€“ Your Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; color: #333; }
    
    .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #0d9d6a 0%, #05672d 100%); }
    .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
    .login-box h1 { font-size: 28px; margin-bottom: 10px; color: #0d9d6a; }
    .login-box p { color: #718096; margin-bottom: 30px; font-size: 14px; }
    
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 12px; color: #4a5568; text-transform: uppercase; font-weight: 600; margin-bottom: 8px; }
    .form-group input { width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; }
    .form-group input:focus { outline: none; border-color: #0d9d6a; box-shadow: 0 0 0 3px rgba(13, 157, 106, 0.1); }
    
    .form-group button { width: 100%; padding: 12px; background: #0d9d6a; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    .form-group button:hover { background: #05672d; }
    .form-group button:disabled { background: #cbd5e0; cursor: not-allowed; }
    
    .error { color: #e53e3e; font-size: 12px; margin-top: 8px; }
    .loading { display: none; font-size: 12px; color: #718096; }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; display: none; }
    .container.authenticated { display: block; }
    
    header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    h2 { font-size: 24px; color: #0d9d6a; }
    .logout-btn { background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .logout-btn:hover { background: #c53030; }
    
    .pro-link-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .pro-link-box h3 { font-size: 16px; margin-bottom: 12px; color: #2c5282; }
    .link-display { background: #f8fafc; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 13px; word-break: break-all; margin-bottom: 8px; }
    .copy-btn { padding: 8px 16px; background: #0d9d6a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
    
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-label { font-size: 12px; color: #718096; text-transform: uppercase; font-weight: 600; }
    .stat-value { font-size: 28px; font-weight: bold; color: #0d9d6a; margin-top: 8px; }
    
    .filters { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
    .filters input, .filters select { padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; }
    .filters button { background: #0d9d6a; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .filters button:hover { background: #05672d; }
    
    .table-container { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #edf2f7; padding: 15px; text-align: left; font-weight: 600; font-size: 12px; color: #4a5568; text-transform: uppercase; border-bottom: 1px solid #cbd5e0; }
    td { padding: 15px; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
    tr:hover { background: #f7fafc; }
    
    .status { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status.open { background: #bee3f8; color: #2c5282; }
    .status.quoted { background: #c6f6d5; color: #22543d; }
    .status.closed { background: #fed7d7; color: #742a2a; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 8px; padding: 30px; max-width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 25px rgba(0,0,0,0.15); }
    .modal-close { float: right; font-size: 28px; font-weight: bold; color: #cbd5e0; cursor: pointer; }
    .modal-close:hover { color: #a0aec0; }
    
    .field { margin-bottom: 20px; }
    .field-label { font-size: 12px; color: #718096; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }
    .field-value { font-size: 14px; color: #2d3748; }
    
    .media-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
    .media-item { border-radius: 6px; overflow: hidden; background: #f8fafc; aspect-ratio: 1; }
    .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; }
    
    .empty-state { padding: 60px 20px; text-align: center; color: #718096; }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="login-container">
    <div class="login-box">
      <h1>EstateQuoter Pro</h1>
      <p>Professional Dashboard</p>
      
      <form id="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" required>
        </div>
        
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" required>
        </div>
        
        <div class="form-group">
          <button type="submit" id="login-btn">Sign In</button>
          <div class="loading" id="login-loading">Signing in...</div>
        </div>
        
        <div class="error" id="login-error"></div>
      </form>

      <p style="margin-top: 20px; text-align: center; font-size: 12px; color: #718096;">
        Don't have an account? 
        <a href="/pro.html" style="color: #0d9d6a; text-decoration: none;">Create your free link</a>
      </p>
    </div>
  </div>

  <!-- DASHBOARD SCREEN -->
  <div id="dashboard-screen" class="container">
    <header>
      <h2>My EstateQuoter Pro Dashboard</h2>
      <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </header>

    <!-- Pro Link Box -->
    <div class="pro-link-box" id="pro-link-section" style="display: none;">
      <h3>Your Professional Link</h3>
      <p style="font-size: 13px; color: #64748b; margin-bottom: 10px;">Share this link with clients to collect leads:</p>
      <div class="link-display" id="pro-link-display"></div>
      <button class="copy-btn" onclick="copyProLink()">Copy Link</button>
    </div>
    
    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-label">Total Leads</div>
        <div class="stat-value" id="total-leads">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Open</div>
        <div class="stat-value" id="open-leads">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Quoted</div>
        <div class="stat-value" id="quoted-leads">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Closed</div>
        <div class="stat-value" id="closed-leads">0</div>
      </div>
    </div>
    
    <div class="filters">
      <input type="text" id="search-box" placeholder="Search by name, email, or phone..." onkeyup="filterLeads()">
      <select id="status-filter" onchange="filterLeads()">
        <option value="">All Status</option>
        <option value="open">Open</option>
        <option value="quoted">Quoted</option>
        <option value="closed">Closed</option>
      </select>
      <button onclick="refreshData()">Refresh</button>
    </div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>ZIP</th>
            <th>Property Type</th>
            <th>Needs</th>
            <th>Status</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="leads-table">
          <tr><td colspan="9" class="empty-state"><p>Loading leads...</p></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="modal" id="detail-modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <h2 id="modal-name"></h2>
      <div id="modal-details"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://dzqjvsabwijgwbhfjzqq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6cWp2c2Fid2lqZ3diaGZqenFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NDMwNjEsImV4cCI6MjA4MDMxOTA2MX0.D6Swjkg5THodl_OnOGngCGU9S98dAPM2HmltJ_p18EI';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let allLeads = [];
    let currentUser = null;
    let currentProfessional = null;
    
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const loginBtn = document.getElementById('login-btn');
      const errorDiv = document.getElementById('login-error');
      
      loginBtn.style.display = 'none';
      document.getElementById('login-loading').style.display = 'block';
      errorDiv.textContent = '';
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        
        currentUser = data.user;
        
        // Find professional account by email
        const { data: professionals, error: proError } = await supabase
          .from('professionals')
          .select('*')
          .eq('email', email)
          .single();
        
        if (proError || !professionals) {
          throw new Error('Professional account not found. Please contact support.');
        }
        
        currentProfessional = professionals;
        showDashboard();
        loadLeads();
      } catch (err) {
        errorDiv.textContent = err.message || 'Login failed';
        loginBtn.style.display = 'block';
        document.getElementById('login-loading').style.display = 'none';
      }
    }
    
    async function handleLogout() {
      await supabase.auth.signOut();
      showLogin();
      document.getElementById('login-form').reset();
      currentUser = null;
      currentProfessional = null;
    }
    
    function showLogin() {
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('dashboard-screen').classList.remove('authenticated');
    }
    
    function showDashboard() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('dashboard-screen').classList.add('authenticated');
      
      // Show pro link
      if (currentProfessional) {
        const link = `https://estatequoter.com/?pro=${currentProfessional.slug}`;
        document.getElementById('pro-link-display').textContent = link;
        document.getElementById('pro-link-section').style.display = 'block';
      }
    }
    
    async function loadLeads() {
      try {
        if (!currentProfessional) return;
        
        const { data, error } = await supabase
          .from('leads')
          .select('*, lead_media(*)')
          .eq('professional_id', currentProfessional.id)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        allLeads = data || [];
        updateStats();
        renderTable();
      } catch (err) {
        document.getElementById('leads-table').innerHTML = `<tr><td colspan="9" class="empty-state"><p>Error loading leads: ${err.message}</p></td></tr>`;
      }
    }
    
    function updateStats() {
      const total = allLeads.length;
      const open = allLeads.filter(l => l.status === 'open').length;
      const quoted = allLeads.filter(l => l.status === 'quoted').length;
      const closed = allLeads.filter(l => l.status === 'closed').length;
      
      document.getElementById('total-leads').textContent = total;
      document.getElementById('open-leads').textContent = open;
      document.getElementById('quoted-leads').textContent = quoted;
      document.getElementById('closed-leads').textContent = closed;
    }
    
    function renderTable() {
      const tbody = document.getElementById('leads-table');
      if (allLeads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><p>No leads yet. Share your link to start receiving requests.</p></td></tr>';
        return;
      }
      
      tbody.innerHTML = allLeads.map(lead => `
        <tr>
          <td>${lead.customer_name || 'N/A'}</td>
          <td>${lead.customer_email || 'N/A'}</td>
          <td>${lead.customer_phone || 'N/A'}</td>
          <td>${lead.zip || 'N/A'}</td>
          <td>${lead.property_type || 'N/A'}</td>
          <td>${lead.needs || 'N/A'}</td>
          <td><span class="status ${lead.status || 'open'}">${(lead.status || 'open').toUpperCase()}</span></td>
          <td>${new Date(lead.created_at).toLocaleDateString()}</td>
          <td><a href="#" onclick="viewDetails(${lead.id}); return false;" style="color: #0d9d6a; text-decoration: none;">View</a></td>
        </tr>
      `).join('');
    }
    
    function filterLeads() {
      const search = document.getElementById('search-box').value.toLowerCase();
      const status = document.getElementById('status-filter').value;
      
      let filtered = allLeads.filter(lead => {
        const matchesSearch = !search || 
          (lead.customer_name && lead.customer_name.toLowerCase().includes(search)) ||
          (lead.customer_email && lead.customer_email.toLowerCase().includes(search)) ||
          (lead.customer_phone && lead.customer_phone.toLowerCase().includes(search));
        
        const matchesStatus = !status || lead.status === status;
        return matchesSearch && matchesStatus;
      });
      
      const tbody = document.getElementById('leads-table');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><p>No leads match your filters</p></td></tr>';
        return;
      }
      
      tbody.innerHTML = filtered.map(lead => `
        <tr>
          <td>${lead.customer_name || 'N/A'}</td>
          <td>${lead.customer_email || 'N/A'}</td>
          <td>${lead.customer_phone || 'N/A'}</td>
          <td>${lead.zip || 'N/A'}</td>
          <td>${lead.property_type || 'N/A'}</td>
          <td>${lead.needs || 'N/A'}</td>
          <td><span class="status ${lead.status || 'open'}">${(lead.status || 'open').toUpperCase()}</span></td>
          <td>${new Date(lead.created_at).toLocaleDateString()}</td>
          <td><a href="#" onclick="viewDetails(${lead.id}); return false;" style="color: #0d9d6a; text-decoration: none;">View</a></td>
        </tr>
      `).join('');
    }
    
    function viewDetails(id) {
      const lead = allLeads.find(l => l.id === id);
      if (!lead) return;
      
      const modal = document.getElementById('detail-modal');
      document.getElementById('modal-name').textContent = lead.customer_name || 'Unknown';
      
      const fields = [
        ['Customer Name', lead.customer_name],
        ['Email', lead.customer_email],
        ['Phone', lead.customer_phone],
        ['ZIP Code', lead.zip],
        ['Role', lead.role],
        ['Needs', lead.needs],
        ['Property Type', lead.property_type],
        ['Square Footage', lead.square_footage],
        ['Bedrooms', lead.bedrooms],
        ['Bathrooms', lead.bathrooms],
        ['Extra Rooms', lead.extra_rooms],
        ['Fullness', lead.fullness],
        ['High Value Items', lead.high_value],
        ['Clear Out Needs', lead.clear_out],
        ['Timeline', lead.timeline],
        ['Oversized Items', lead.oversized],
        ['Access', lead.access],
        ['Home Value', lead.home_value ? '$' + lead.home_value.toLocaleString() : null],
        ['Notes', lead.notes],
        ['Status', lead.status],
        ['Date Submitted', new Date(lead.created_at).toLocaleString()],
      ];
      
      let detailsHTML = fields
        .filter(([_, val]) => val)
        .map(([label, value]) => `
          <div class="field">
            <div class="field-label">${label}</div>
            <div class="field-value">${value}</div>
          </div>
        `).join('');
      
      // Add media gallery if present
      if (lead.lead_media && lead.lead_media.length > 0) {
        detailsHTML += `
          <div class="field">
            <div class="field-label">Media (Photos/Video)</div>
            <div class="media-gallery">
              ${lead.lead_media.map(m => {
                const isVideo = m.media_type === 'video';
                const tag = isVideo 
                  ? `<video src="${m.cloudinary_url}" controls style="width: 100%; height: 100%;"></video>`
                  : `<img src="${m.cloudinary_url}" alt="">`;
                return `<div class="media-item">${tag}</div>`;
              }).join('')}
            </div>
          </div>
        `;
      }
      
      document.getElementById('modal-details').innerHTML = detailsHTML;
      modal.classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('detail-modal').classList.remove('active');
    }
    
    function refreshData() {
      loadLeads();
    }
    
    function copyProLink() {
      if (!currentProfessional) return;
      const link = `https://estatequoter.com/?pro=${currentProfessional.slug}`;
      navigator.clipboard.writeText(link).then(() => {
        alert('Link copied to clipboard!');
      });
    }
    
    // Check if user is already logged in
    supabase.auth.onAuthStateChange((event, session) => {
      if (session) {
        currentUser = session.user;
        
        // Find professional account
        supabase
          .from('professionals')
          .select('*')
          .eq('email', session.user.email)
          .single()
          .then(({ data, error }) => {
            if (data) {
              currentProfessional = data;
              showDashboard();
              loadLeads();
            } else {
              handleLogout();
            }
          });
      } else {
        showLogin();
      }
    });
  </script>
</body>
</html>

