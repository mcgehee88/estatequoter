<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EstateQuoter â€“ Professional Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; color: #333; }
    
    .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
    .login-box h1 { font-size: 28px; margin-bottom: 10px; color: #2c5282; }
    .login-box p { color: #718096; margin-bottom: 30px; font-size: 14px; }
    
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 12px; color: #4a5568; text-transform: uppercase; font-weight: 600; margin-bottom: 8px; }
    .form-group input { width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; }
    .form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    
    .form-group button { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    .form-group button:hover { background: #5568d3; }
    .form-group button:disabled { background: #cbd5e0; cursor: not-allowed; }
    
    .error { color: #e53e3e; font-size: 12px; margin-top: 8px; }
    .loading { display: none; }
    
    .container { max-width: 1600px; margin: 0 auto; padding: 20px; display: none; }
    .container.authenticated { display: block; }
    
    header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    h2 { font-size: 24px; color: #2c5282; }
    .logout-btn { background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .logout-btn:hover { background: #c53030; }
    
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-label { font-size: 12px; color: #718096; text-transform: uppercase; font-weight: 600; }
    .stat-value { font-size: 28px; font-weight: bold; color: #2c5282; margin-top: 8px; }
    
    .filters { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
    .filters input, .filters select { padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; }
    .filters button { background: #2c5282; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .filters button:hover { background: #1e3a5f; }
    .filters .refresh-btn { background: #48bb78; }
    .filters .refresh-btn:hover { background: #38a169; }
    
    .table-wrapper { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #edf2f7; padding: 15px; text-align: left; font-weight: 600; font-size: 11px; color: #4a5568; text-transform: uppercase; border-bottom: 1px solid #cbd5e0; white-space: nowrap; }
    td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; font-size: 13px; }
    tr:hover { background: #f7fafc; }
    
    .status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .status.open { background: #bee3f8; color: #2c5282; }
    .status.quoted { background: #c6f6d5; color: #22543d; }
    .status.closed { background: #fed7d7; color: #742a2a; }
    
    .action-btn { padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; text-decoration: none; display: inline-block; }
    .action-btn:hover { background: #5568d3; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 40px; max-width: 900px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
    .modal-close { float: right; font-size: 28px; font-weight: bold; color: #cbd5e0; cursor: pointer; margin: -10px; }
    .modal-close:hover { color: #a0aec0; }
    .modal h2 { color: #2c5282; margin-bottom: 30px; font-size: 24px; clear: both; }
    
    .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
    .detail-section { background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; }
    .detail-section h3 { color: #2c5282; font-size: 13px; text-transform: uppercase; font-weight: 600; margin-bottom: 15px; }
    
    .field { margin-bottom: 15px; }
    .field-label { font-size: 11px; color: #718096; text-transform: uppercase; font-weight: 600; margin-bottom: 4px; }
    .field-value { font-size: 14px; color: #2d3748; line-height: 1.5; word-break: break-word; }
    
    .media-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
    .media-item { border-radius: 6px; overflow: hidden; background: #e2e8f0; aspect-ratio: 1; cursor: pointer; }
    .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; }
    
    .geo-info { background: #f0f7ff; border: 1px solid #bee3f8; border-radius: 6px; padding: 12px; font-size: 12px; color: #2c5282; }
    
    .empty-state { padding: 60px 20px; text-align: center; color: #718096; }
    
    @media (max-width: 768px) {
      th, td { padding: 10px; font-size: 12px; }
      .details-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="login-container">
    <div class="login-box">
      <h1>EstateQuoter</h1>
      <p>Professional Dashboard Login</p>
      
      <form id="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" required>
        </div>
        
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" required>
        </div>
        
        <div class="form-group">
          <button type="submit" id="login-btn">Sign In</button>
          <div class="loading" id="login-loading">Signing in...</div>
        </div>
        
        <div class="error" id="login-error"></div>
      </form>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="container" id="dashboard">
    <header>
      <h2>EstateQuoter â€“ Professional Dashboard</h2>
      <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
    </header>

    <div class="stats" id="stats-container">
      <div class="stat-card">
        <div class="stat-label">Total Leads</div>
        <div class="stat-value" id="stat-total">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Open Leads</div>
        <div class="stat-value" id="stat-open">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Quoted</div>
        <div class="stat-value" id="stat-quoted">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Closed</div>
        <div class="stat-value" id="stat-closed">0</div>
      </div>
    </div>

    <div class="filters">
      <input type="text" id="search-box" placeholder="Search by name, email, or phone..." style="flex: 1; min-width: 250px;">
      <select id="status-filter">
        <option value="">All Statuses</option>
        <option value="open">Open</option>
        <option value="quoted">Quoted</option>
        <option value="closed">Closed</option>
      </select>
      <button onclick="filterLeads()" style="background: #2c5282;">Filter</button>
      <button class="refresh-btn" onclick="loadLeads()">Refresh Data</button>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>ZIP</th>
            <th>Property Type</th>
            <th>Primary Need</th>
            <th>Timeline</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="leads-table">
          <tr><td colspan="10" class="empty-state">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div class="modal" id="detail-modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <h2 id="modal-name">Lead Details</h2>
      
      <div class="details-grid" id="modal-details"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://dzqjvsabwijgwbhfjzqq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6cWp2c2Fid2lqZ3diaGZqenFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NDMwNjEsImV4cCI6MjA4MDMxOTA1MX0.D6Swjkg5THodl_OnOGngCGU9S98dAPM2HmltJ_p18EI';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let allLeads = [];

    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      
      document.getElementById('login-btn').disabled = true;
      document.getElementById('login-loading').style.display = 'block';
      document.getElementById('login-error').textContent = '';
      
      try {
        const res = await fetch('/.netlify/functions/auth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Login failed');
        }
        
        // Store session token
        localStorage.setItem('estatequoter_session', JSON.stringify(data.session));
        localStorage.setItem('estatequoter_user', JSON.stringify(data.user));
        
        // Show dashboard
        showDashboard();
        loadLeads();
      } catch (error) {
        document.getElementById('login-error').textContent = error.message;
        document.getElementById('login-btn').disabled = false;
        document.getElementById('login-loading').style.display = 'none';
      }
    }

    async function handleLogout() {
      localStorage.removeItem('estatequoter_session');
      localStorage.removeItem('estatequoter_user');
      showLogin();
    }

    function checkAuth() {
      const session = localStorage.getItem('estatequoter_session');
      if (session) {
        showDashboard();
        loadLeads();
      } else {
        showLogin();
      }
    }

    function showLogin() {
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('dashboard').classList.remove('authenticated');
    }

    function showDashboard() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('dashboard').classList.add('authenticated');
    }

    async function loadLeads() {
      try {
        const res = await fetch('/.netlify/functions/admin-get-leads');
        const data = await res.json();
        
        if (!res.ok) throw new Error(data.error || 'Failed to load leads');
        
        allLeads = data.leads || [];
        updateStats();
        renderLeads();
      } catch (error) {
        console.error('Error loading leads:', error);
        alert('Failed to load leads: ' + error.message);
      }
    }

    function updateStats() {
      const total = allLeads.length;
      const open = allLeads.filter(l => l.status === 'open').length;
      const quoted = allLeads.filter(l => l.status === 'quoted').length;
      const closed = allLeads.filter(l => l.status === 'closed').length;
      
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-open').textContent = open;
      document.getElementById('stat-quoted').textContent = quoted;
      document.getElementById('stat-closed').textContent = closed;
    }

    function renderLeads() {
      const tbody = document.getElementById('leads-table');
      
      if (allLeads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><p>No leads yet</p></td></tr>';
        return;
      }
      
      tbody.innerHTML = allLeads.map(lead => `
        <tr>
          <td>${lead.customer_name || 'N/A'}</td>
          <td>${lead.customer_email || 'N/A'}</td>
          <td>${lead.customer_phone || 'N/A'}</td>
          <td>${lead.zip || 'N/A'}</td>
          <td>${lead.property_type || 'N/A'}</td>
          <td>${(lead.needs || 'N/A').substring(0, 30)}</td>
          <td>${lead.timeline || 'N/A'}</td>
          <td><span class="status ${lead.status || 'open'}">${(lead.status || 'open').toUpperCase()}</span></td>
          <td>${new Date(lead.created_at).toLocaleDateString()}</td>
          <td><button class="action-btn" onclick="viewDetails(${lead.id})">View Full</button></td>
        </tr>
      `).join('');
    }

    function viewDetails(id) {
      const lead = allLeads.find(l => l.id === id);
      if (!lead) return;
      
      const modal = document.getElementById('detail-modal');
      document.getElementById('modal-name').textContent = `${lead.customer_name} â€“ Lead #${lead.id.substring(0, 8)}`;
      
      const sections = {
        'ðŸ“‹ Contact Information': [
          ['Name', lead.customer_name],
          ['Email', lead.customer_email],
          ['Phone', lead.customer_phone],
          ['ZIP Code', lead.zip],
        ],
        'ðŸ  Property Details': [
          ['Property Type', lead.property_type],
          ['Square Footage', lead.square_footage],
          ['Bedrooms', lead.bedrooms],
          ['Bathrooms', lead.bathrooms],
          ['Estimated Home Value', lead.home_value ? `$${lead.home_value.toLocaleString()}` : 'Not provided'],
        ],
        'ðŸ’¼ Service Needs': [
          ['Primary Need', lead.needs],
          ['Secondary Needs', lead.needs_other],
          ['Role/Relationship', lead.role],
          ['Role Details', lead.role_other],
          ['Clear Out Required', lead.clear_out],
          ['Timeline', lead.timeline],
        ],
        'ðŸŽ¯ Item Assessment': [
          ['High Value Items', lead.high_value],
          ['High Value Details', lead.high_value_other],
          ['Oversized Items', lead.oversized],
          ['Oversized Details', lead.oversized_other],
          ['Extra Room Items', lead.extra_rooms],
          ['Extra Room Details', lead.extra_rooms_other],
        ],
        'ðŸ” Property Condition': [
          ['Fullness Level', lead.fullness],
          ['Access Issues', lead.access],
          ['Access Details', lead.access_other],
          ['Media Files Attached', lead.media_count ? `${lead.media_count} file(s)` : 'None'],
          ['Has Media', lead.has_media ? 'Yes' : 'No'],
        ],
        'ðŸŒ Geolocation Data': [
          ['IP Address', lead.ip],
          ['City', lead.city],
          ['Region/State', lead.region],
          ['Country', lead.country],
          ['Postal Code', lead.postal],
          ['Coordinates', lead.latitude && lead.longitude ? `${lead.latitude.toFixed(4)}, ${lead.longitude.toFixed(4)}` : 'N/A'],
          ['ISP', lead.isp],
          ['VPN Detected', lead.likely_vpn ? 'Yes - High Risk' : 'No'],
        ],
        'ðŸ’» Device & Browser': [
          ['Device Type', lead.device],
          ['User Agent', lead.user_agent],
          ['Referrer', lead.referrer],
          ['Page URL', lead.page_url],
        ],
        'ðŸ“Š Lead Status': [
          ['Status', lead.status],
          ['Date Submitted', lead.created_at ? new Date(lead.created_at).toLocaleString() : 'N/A'],
          ['Professional Assigned', lead.professional_id ? `ID: ${lead.professional_id}` : 'Not assigned yet'],
          ['Notes/Message', lead.notes],
        ],
      };
      
      let html = '';
      for (const [sectionTitle, fields] of Object.entries(sections)) {
        const sectionContent = fields
          .filter(([_, val]) => val && val !== 'N/A' && val !== '' && val !== 'null' && val !== '0' && val !== 'Not provided' && val !== 'None')
          .map(([label, value]) => `
            <div class="field">
              <div class="field-label">${label}</div>
              <div class="field-value">${value}</div>
            </div>
          `).join('');
        
        if (sectionContent) {
          html += `<div class="detail-section"><h3>${sectionTitle}</h3>${sectionContent}</div>`;
        }
      }
      
      if (!html) {
        html = '<div class="empty-state"><p>No detailed information available</p></div>';
      }
      
      document.getElementById('modal-details').innerHTML = html;
      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('detail-modal').classList.remove('active');
    }

    function filterLeads() {
      const search = document.getElementById('search-box').value.toLowerCase();
      const status = document.getElementById('status-filter').value;
      
      let filtered = allLeads.filter(lead => {
        const matchesSearch = !search || 
          (lead.customer_name && lead.customer_name.toLowerCase().includes(search)) ||
          (lead.customer_email && lead.customer_email.toLowerCase().includes(search)) ||
          (lead.customer_phone && lead.customer_phone.toLowerCase().includes(search));
        
        const matchesStatus = !status || lead.status === status;
        return matchesSearch && matchesStatus;
      });
      
      const tbody = document.getElementById('leads-table');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><p>No leads match your filters</p></td></tr>';
        return;
      }
      
      tbody.innerHTML = filtered.map(lead => `
        <tr>
          <td>${lead.customer_name || 'N/A'}</td>
          <td>${lead.customer_email || 'N/A'}</td>
          <td>${lead.customer_phone || 'N/A'}</td>
          <td>${lead.zip || 'N/A'}</td>
          <td>${lead.property_type || 'N/A'}</td>
          <td>${(lead.needs || 'N/A').substring(0, 30)}</td>
          <td>${lead.timeline || 'N/A'}</td>
          <td><span class="status ${lead.status || 'open'}">${(lead.status || 'open').toUpperCase()}</span></td>
          <td>${new Date(lead.created_at).toLocaleDateString()}</td>
          <td><button class="action-btn" onclick="viewDetails(${lead.id})">View Full</button></td>
        </tr>
      `).join('');
    }

    checkAuth();
  </script>
</body>
</html>




