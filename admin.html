<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EstateQuoter â€“ Professional Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f0f4f8; color: #2d3748; }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 32px; font-weight: 700; margin-bottom: 10px; color: #1a202c; }
    .subtitle { color: #718096; font-size: 16px; margin-bottom: 30px; }
    
    .login-container { max-width: 400px; margin: 60px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .login-container h2 { color: #2c5282; margin-bottom: 30px; text-align: center; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: #2d3748; }
    .form-group input { width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; }
    .form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .btn { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; width: 100%; }
    .btn:hover { background: #5568d3; }
    .error { color: #e53e3e; font-size: 14px; margin-top: 10px; }
    
    .dashboard-hidden { display: none; }
    .login-hidden { display: none; }
    
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .stat-label { color: #718096; font-size: 14px; margin-bottom: 8px; text-transform: uppercase; font-weight: 600; }
    .stat-value { font-size: 32px; font-weight: 700; color: #2c5282; }
    
    .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .controls input, .controls select { padding: 10px 15px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; }
    .controls input { flex: 1; min-width: 200px; }
    .controls select { min-width: 150px; }
    .logout-btn { padding: 10px 20px; background: #f56565; color: white; border: none; border-radius: 6px; cursor: pointer; }
    
    table { width: 100%; background: white; border-collapse: collapse; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    thead { background: #edf2f7; }
    th { padding: 16px; text-align: left; font-weight: 600; color: #4a5568; font-size: 13px; text-transform: uppercase; }
    td { padding: 16px; border-top: 1px solid #e2e8f0; }
    tr:hover { background: #f7fafc; }
    
    .action-btn { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .action-btn:hover { background: #5568d3; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 40px; max-width: 1000px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
    .modal-close { float: right; font-size: 28px; font-weight: bold; color: #cbd5e0; cursor: pointer; margin: -15px -15px 0 0; line-height: 1; }
    .modal-close:hover { color: #a0aec0; }
    .modal h2 { color: #2c5282; margin-bottom: 30px; font-size: 24px; clear: both; }
    
    .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
    .detail-section { background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; }
    .detail-section h3 { color: #2c5282; font-size: 12px; text-transform: uppercase; font-weight: 700; margin-bottom: 18px; letter-spacing: 0.5px; }
    .field { margin-bottom: 16px; }
    .field-label { font-size: 11px; color: #718096; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; letter-spacing: 0.3px; }
    .field-value { font-size: 14px; color: #2d3748; line-height: 1.6; word-break: break-word; }
    
    .empty-state { text-align: center; padding: 40px; color: #718096; }
    .empty-message { text-align: center; padding: 40px; }
    
    @media (max-width: 768px) {
      .details-grid { grid-template-columns: 1fr; }
      table { font-size: 12px; }
      th, td { padding: 10px; }
      .controls { flex-direction: column; }
      .controls input { min-width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="login-container">
    <h2>EstateQuoter Admin</h2>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" required placeholder="estatequoter@gmail.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="password" required placeholder="Enter password">
      </div>
      <button type="submit" class="btn">Login</button>
      <div id="login-error" class="error"></div>
    </form>
  </div>

  <!-- Dashboard Screen -->
  <div id="dashboard-screen" class="dashboard-hidden">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
          <h1>Estate Liquidation Leads</h1>
          <p class="subtitle">Manage and view all intake form submissions</p>
        </div>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">Total Leads</div>
          <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">New/Open</div>
          <div class="stat-value" id="stat-open">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Quoted</div>
          <div class="stat-value" id="stat-quoted">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Closed</div>
          <div class="stat-value" id="stat-closed">0</div>
        </div>
      </div>

      <div class="controls">
        <input type="text" id="search-box" placeholder="Search by name, email, or phone..." onkeyup="filterLeads()">
        <select id="status-filter" onchange="filterLeads()">
          <option value="">All Status</option>
          <option value="open">Open</option>
          <option value="quoted">Quoted</option>
          <option value="closed">Closed</option>
        </select>
      </div>

      <table id="leads-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>ZIP</th>
            <th>Property Type</th>
            <th>Primary Need</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="leads-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal" id="detail-modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <h2 id="modal-name">Lead Details</h2>
      <div class="details-grid" id="modal-details"></div>
    </div>
  </div>

  <script>
    let allLeads = [];

    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');

      try {
        const response = await fetch('/.netlify/functions/auth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          errorDiv.textContent = 'Invalid email or password';
          return;
        }

        localStorage.setItem('estatequoter_token', data.session.access_token);
        showDashboard();
        loadLeads();
      } catch (error) {
        errorDiv.textContent = 'Login failed: ' + error.message;
      }
    }

    function handleLogout() {
      localStorage.removeItem('estatequoter_token');
      showLogin();
    }

    function showLogin() {
      document.getElementById('login-screen').style.display = 'block';
      document.getElementById('dashboard-screen').classList.add('dashboard-hidden');
    }

    function showDashboard() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('dashboard-screen').classList.remove('dashboard-hidden');
    }

    async function loadLeads() {
      try {
        const response = await fetch('/.netlify/functions/admin-get-leads');
        const data = await response.json();

        if (!response.ok) {
          console.error('Error loading leads:', data);
          return;
        }

        allLeads = data.leads || [];
        updateStats();
        renderLeads();
      } catch (error) {
        console.error('Failed to load leads:', error);
      }
    }

    function updateStats() {
      const total = allLeads.length;
      const open = allLeads.filter(l => l.status === 'open' || !l.status).length;
      const quoted = allLeads.filter(l => l.status === 'quoted').length;
      const closed = allLeads.filter(l => l.status === 'closed').length;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-open').textContent = open;
      document.getElementById('stat-quoted').textContent = quoted;
      document.getElementById('stat-closed').textContent = closed;
    }

    function renderLeads() {
      const tbody = document.getElementById('leads-tbody');
      
      if (allLeads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">No leads yet</td></tr>';
        return;
      }

      tbody.innerHTML = allLeads.map(lead => `
        <tr>
          <td>${lead.customer_name || 'N/A'}</td>
          <td>${lead.customer_email || 'N/A'}</td>
          <td>${lead.customer_phone || 'N/A'}</td>
          <td>${lead.zip || 'N/A'}</td>
          <td>${lead.property_type || 'N/A'}</td>
          <td>${lead.needs || 'N/A'}</td>
          <td><strong>${lead.status || 'open'}</strong></td>
          <td>${lead.created_at ? new Date(lead.created_at).toLocaleDateString() : 'N/A'}</td>
          <td><button class="action-btn" onclick="viewDetails('${lead.id}')">View Full</button></td>
        </tr>
      `).join('');
    }

    function viewDetails(id) {
      const lead = allLeads.find(l => l.id === id);
      if (!lead) {
        console.error('Lead not found:', id);
        return;
      }

      document.getElementById('modal-name').textContent = `${lead.customer_name || 'N/A'} â€“ Lead #${(id || '').substring(0, 8)}`;

      const sections = {
        'ðŸ“‹ Contact Information': [
          ['Name', lead.customer_name],
          ['Email', lead.customer_email],
          ['Phone', lead.customer_phone],
          ['ZIP Code', lead.zip],
        ],
        'ðŸ  Property Details': [
          ['Property Type', lead.property_type],
          ['Square Footage', lead.square_footage],
          ['Bedrooms', lead.bedrooms],
          ['Bathrooms', lead.bathrooms],
          ['Estimated Home Value', lead.home_value ? `$${lead.home_value.toLocaleString()}` : 'Not provided'],
        ],
        'ðŸ’¼ Service Needs': [
          ['Primary Need', lead.needs],
          ['Secondary Needs', lead.needs_other],
          ['Role/Relationship', lead.role],
          ['Role Details', lead.role_other],
          ['Clear Out Required', lead.clear_out],
          ['Timeline', lead.timeline],
        ],
        'ðŸŽ¯ Item Assessment': [
          ['High Value Items', lead.high_value],
          ['High Value Details', lead.high_value_other],
          ['Oversized Items', lead.oversized],
          ['Oversized Details', lead.oversized_other],
          ['Extra Room Items', lead.extra_rooms],
          ['Extra Room Details', lead.extra_rooms_other],
        ],
        'ðŸ” Property Condition': [
          ['Fullness Level', lead.fullness],
          ['Access Issues', lead.access],
          ['Access Details', lead.access_other],
          ['Media Files Attached', lead.media_count ? `${lead.media_count} file(s)` : 'None'],
        ],
        'ðŸŒ Geolocation Data': [
          ['IP Address', lead.ip],
          ['City', lead.city],
          ['Region/State', lead.region],
          ['Country', lead.country],
          ['Postal Code', lead.postal],
          ['Latitude', lead.latitude],
          ['Longitude', lead.longitude],
          ['ISP', lead.isp],
          ['VPN Detected', lead.likely_vpn ? 'Yes - Suspicious' : 'No'],
        ],
        'ðŸ’» Device & Browser': [
          ['Device Type', lead.device],
          ['User Agent', lead.user_agent],
          ['Referrer', lead.referrer],
          ['Page URL', lead.page_url],
        ],
        'ðŸ“Š Lead Status': [
          ['Status', lead.status || 'open'],
          ['Date Submitted', lead.created_at ? new Date(lead.created_at).toLocaleString() : 'N/A'],
          ['Professional Assigned', lead.professional_id || 'Not assigned'],
          ['Notes', lead.notes || 'None'],
        ],
      };

      let html = '';
      for (const [sectionTitle, fields] of Object.entries(sections)) {
        const sectionContent = fields
          .filter(([_, val]) => val && val !== 'null' && val !== '' && val !== 'N/A' && val !== 'Not provided' && val !== 'None')
          .map(([label, value]) => `
            <div class="field">
              <div class="field-label">${label}</div>
              <div class="field-value">${value}</div>
            </div>
          `).join('');

        if (sectionContent) {
          html += `<div class="detail-section"><h3>${sectionTitle}</h3>${sectionContent}</div>`;
        }
      }

      if (!html) {
        html = '<div class="empty-state"><p>No detailed information available</p></div>';
      }

      document.getElementById('modal-details').innerHTML = html;
      document.getElementById('detail-modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('detail-modal').classList.remove('active');
    }

    function filterLeads() {
      const search = document.getElementById('search-box').value.toLowerCase();
      const status = document.getElementById('status-filter').value;

      const filtered = allLeads.filter(lead => {
        const matchesSearch = !search || 
          (lead.customer_name && lead.customer_name.toLowerCase().includes(search)) ||
          (lead.customer_email && lead.customer_email.toLowerCase().includes(search)) ||
          (lead.customer_phone && lead.customer_phone.includes(search));

        const matchesStatus = !status || lead.status === status || (!lead.status && status === 'open');

        return matchesSearch && matchesStatus;
      });

      const tbody = document.getElementById('leads-tbody');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">No leads match your search</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(lead => `
        <tr>
          <td>${lead.customer_name || 'N/A'}</td>
          <td>${lead.customer_email || 'N/A'}</td>
          <td>${lead.customer_phone || 'N/A'}</td>
          <td>${lead.zip || 'N/A'}</td>
          <td>${lead.property_type || 'N/A'}</td>
          <td>${lead.needs || 'N/A'}</td>
          <td><strong>${lead.status || 'open'}</strong></td>
          <td>${lead.created_at ? new Date(lead.created_at).toLocaleDateString() : 'N/A'}</td>
          <td><button class="action-btn" onclick="viewDetails('${lead.id}')">View Full</button></td>
        </tr>
      `).join('');
    }

    // Check auth on load
    window.addEventListener('load', () => {
      const token = localStorage.getItem('estatequoter_token');
      if (token) {
        showDashboard();
        loadLeads();
      } else {
        showLogin();
      }
    });
  </script>
</body>
</html>


