<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>EstateQuoter â€“ Professional Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; width: 100%; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
      background: #f0f4f8; 
      color: #2d3748; 
      font-size: 16px;
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #1a202c; }
    .subtitle { color: #718096; font-size: 14px; margin-bottom: 24px; }
    
    /* LOGIN */
    .login-container { 
      max-width: 100%;
      width: 100%;
      max-width: 400px;
      margin: 40px auto;
      background: white; 
      padding: 32px 24px; 
      border-radius: 12px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
    }
    .login-container h2 { color: #2c5282; margin-bottom: 24px; text-align: center; font-size: 22px; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: #2d3748; font-size: 14px; }
    .form-group input { 
      width: 100%; 
      padding: 14px 12px; 
      border: 1px solid #cbd5e0; 
      border-radius: 8px; 
      font-size: 16px;
      -webkit-appearance: none;
      appearance: none;
    }
    .form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .btn { 
      padding: 14px 24px; 
      background: #667eea; 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 16px; 
      font-weight: 500; 
      width: 100%; 
      -webkit-appearance: none;
      appearance: none;
    }
    .btn:active { background: #5568d3; opacity: 0.95; }
    .btn:hover { background: #5568d3; }
    .error { color: #e53e3e; font-size: 13px; margin-top: 8px; }
    
    .dashboard-hidden { display: none; }
    .login-hidden { display: none; }
    
    /* HEADER */
    .header-top { 
      display: flex; 
      justify-content: space-between; 
      align-items: flex-start; 
      margin-bottom: 24px; 
      gap: 12px;
      flex-wrap: wrap;
    }
    .header-top > div { flex: 1; min-width: 200px; }
    
    /* STATS */
    .stats { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
      gap: 12px; 
      margin-bottom: 24px; 
    }
    .stat-card { 
      background: white; 
      padding: 18px; 
      border-radius: 10px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.08); 
    }
    .stat-label { color: #718096; font-size: 12px; margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
    .stat-value { font-size: 28px; font-weight: 700; color: #2c5282; }
    
    /* CONTROLS */
    .controls { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 18px; 
      flex-wrap: wrap;
    }
    .controls input, .controls select { 
      padding: 12px 12px; 
      border: 1px solid #cbd5e0; 
      border-radius: 8px; 
      font-size: 14px;
      -webkit-appearance: none;
      appearance: none;
      background-image: none;
    }
    .controls input { 
      flex: 1; 
      min-width: 150px; 
    }
    .controls select { 
      min-width: 130px;
      background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 20px;
      padding-right: 32px;
    }
    .logout-btn { 
      padding: 11px 18px; 
      background: #f56565; 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      -webkit-appearance: none;
      appearance: none;
    }
    .logout-btn:active { opacity: 0.9; }
    
    /* TABLE */
    .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px; }
    table { 
      width: 100%; 
      background: white; 
      border-collapse: collapse; 
      border-radius: 8px; 
      overflow: hidden; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.08); 
      font-size: 14px;
    }
    thead { background: #edf2f7; }
    th { 
      padding: 14px; 
      text-align: left; 
      font-weight: 600; 
      color: #4a5568; 
      font-size: 12px; 
      text-transform: uppercase;
      white-space: nowrap;
    }
    td { 
      padding: 14px; 
      border-top: 1px solid #e2e8f0; 
      word-break: break-word;
      max-width: 200px;
    }
    tr:active { background: #f0f4f8; }
    
    .action-btn { 
      padding: 10px 14px; 
      background: #667eea; 
      color: white; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 13px;
      font-weight: 500;
      -webkit-appearance: none;
      appearance: none;
      white-space: nowrap;
    }
    .action-btn:active { background: #5568d3; }
    
    /* MODAL */
    .modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.5); 
      z-index: 2000; 
      align-items: flex-start;
      justify-content: center;
      overflow-y: auto; 
      padding: 12px;
      padding-top: 60px;
    }
    .modal.active { display: flex; }
    .modal-content { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      width: 100%;
      max-width: 900px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
      max-height: calc(100vh - 80px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal-close { 
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 28px; 
      font-weight: bold; 
      color: #cbd5e0; 
      cursor: pointer; 
      line-height: 1;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 50%;
    }
    .modal-close:active { color: #a0aec0; }
    .modal h2 { 
      color: #2c5282; 
      margin-bottom: 20px; 
      font-size: 20px;
      padding-right: 50px;
    }
    
    .details-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 16px; 
    }
    .detail-section { 
      background: #f8fafc; 
      padding: 16px; 
      border-radius: 8px; 
      border-left: 4px solid #667eea; 
    }
    .detail-section h3 { 
      color: #2c5282; 
      font-size: 11px; 
      text-transform: uppercase; 
      font-weight: 700; 
      margin-bottom: 12px; 
      letter-spacing: 0.5px; 
    }
    .field { margin-bottom: 12px; }
    .field-label { 
      font-size: 11px; 
      color: #718096; 
      text-transform: uppercase; 
      font-weight: 600; 
      margin-bottom: 3px; 
      letter-spacing: 0.3px; 
    }
    .field-value { 
      font-size: 13px; 
      color: #2d3748; 
      line-height: 1.5; 
      word-break: break-word; 
    }
    
    .empty-message { text-align: center; padding: 40px 20px; color: #718096; }
    
    /* MOBILE */
    @media (max-width: 768px) {
      .container { padding: 12px; }
      
      h1 { font-size: 22px; }
      .subtitle { font-size: 13px; margin-bottom: 16px; }
      
      .header-top { margin-bottom: 16px; }
      
      .stats { 
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 16px;
      }
      .stat-card { padding: 14px; }
      .stat-label { font-size: 11px; }
      .stat-value { font-size: 24px; }
      
      .controls { 
        gap: 8px;
        margin-bottom: 16px;
      }
      .controls input {
        min-width: 100%;
        flex: 0 0 100%;
      }
      .controls select {
        flex: 1;
        min-width: 50%;
      }
      
      .table-wrapper { 
        overflow-x: auto;
        margin-bottom: 16px;
      }
      table { font-size: 13px; }
      th, td { 
        padding: 10px 8px;
      }
      th { font-size: 11px; }
      td { font-size: 12px; max-width: 120px; }
      
      .action-btn { 
        padding: 8px 10px;
        font-size: 12px;
      }
      
      .modal { 
        padding: 8px;
        padding-top: 50px;
      }
      .modal-content { 
        padding: 16px;
        max-height: calc(100vh - 60px);
      }
      .modal h2 { 
        font-size: 18px;
        margin-bottom: 16px;
      }
      
      .details-grid { 
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .detail-section { 
        padding: 12px;
      }
      .detail-section h3 { 
        font-size: 10px;
        margin-bottom: 10px;
      }
      .field { margin-bottom: 10px; }
      .field-label { font-size: 10px; margin-bottom: 2px; }
      .field-value { font-size: 12px; }
      
      .logout-btn {
        padding: 10px 14px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .container { padding: 10px; }
      
      h1 { font-size: 20px; margin-bottom: 6px; }
      
      .stats { grid-template-columns: 1fr; }
      
      .controls { 
        flex-direction: column;
        gap: 8px;
      }
      .controls input,
      .controls select {
        width: 100%;
      }
      
      th, td { 
        padding: 8px 6px;
        font-size: 11px;
      }
      td { max-width: 100px; }
      
      .action-btn { 
        padding: 8px 8px;
        font-size: 11px;
      }
      
      .details-grid { gap: 10px; }
      .field-value { font-size: 11px; }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="login-container">
    <h2>EstateQuoter Admin</h2>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" required placeholder="Email" autocomplete="email">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="password" required placeholder="Enter password" autocomplete="current-password">
      </div>
      <button type="submit" class="btn">Login</button>
      <div id="login-error" class="error"></div>
    </form>
  </div>

  <!-- Dashboard Screen -->
  <div id="dashboard-screen" class="dashboard-hidden">
    <div class="container">
      <div class="header-top">
        <div>
          <h1>Estate Liquidation Leads</h1>
          <p class="subtitle">Manage intake submissions</p>
        </div>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">Total</div>
          <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Open</div>
          <div class="stat-value" id="stat-open">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Quoted</div>
          <div class="stat-value" id="stat-quoted">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Closed</div>
          <div class="stat-value" id="stat-closed">0</div>
        </div>
      </div>

      <div class="controls">
        <input type="text" id="search-box" placeholder="Search..." onkeyup="filterLeads()">
        <select id="status-filter" onchange="filterLeads()">
          <option value="">All Status</option>
          <option value="open">Open</option>
          <option value="quoted">Quoted</option>
          <option value="closed">Closed</option>
        </select>
      </div>

      <div class="table-wrapper">
        <table id="leads-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>ZIP</th>
              <th>Type</th>
              <th>Need</th>
              <th>Status</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="leads-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal" id="detail-modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <h2 id="modal-name">Lead Details</h2>
      <div class="details-grid" id="modal-details"></div>
    </div>
  </div>

  <script>
    let allLeads = [];
    let sessionToken = localStorage.getItem('admin_session') || null;

    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');

      try {
        console.log('Attempting login with:', email);
        const response = await fetch('/.netlify/functions/auth-login', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ email, password }),
        });

        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (data.success) {
          sessionToken = data.session.access_token;
          localStorage.setItem('admin_session', sessionToken);
          showDashboard();
          loadLeads();
        } else {
          errorDiv.textContent = data.error || 'Login failed';
          console.error('Login error:', data.error);
        }
      } catch (error) {
        console.error('Fetch error:', error);
        errorDiv.textContent = 'Error logging in: ' + error.message;
      }
    }

    async function loadLeads() {
      try {
        const response = await fetch('/.netlify/functions/admin-get-leads');
        const data = await response.json();

        if (data.leads) {
          allLeads = data.leads;
          renderTable(allLeads);
          updateStats(allLeads);
        }
      } catch (error) {
        console.error('Error loading leads:', error);
      }
    }

    function renderTable(leads) {
      const tbody = document.getElementById('leads-tbody');
      if (leads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-message">No leads found</td></tr>';
        return;
      }

      tbody.innerHTML = leads.map(lead => `
        <tr>
          <td>${lead.customer_name || '-'}</td>
          <td>${lead.customer_email || '-'}</td>
          <td>${lead.customer_phone || '-'}</td>
          <td>${lead.zip || '-'}</td>
          <td>${lead.property_type || '-'}</td>
          <td>${lead.needs || '-'}</td>
          <td>${lead.status || 'open'}</td>
          <td>${new Date(lead.created_at).toLocaleDateString()}</td>
          <td><button class="action-btn" onclick="viewDetails('${lead.id}')">View</button></td>
        </tr>
      `).join('');
    }

    function viewDetails(id) {
      const lead = allLeads.find(l => l.id === id);
      if (!lead) return;

      document.getElementById('modal-name').textContent = lead.customer_name || 'Lead Details';
      
      const sections = {
        'Contact Info': ['customer_name', 'customer_email', 'customer_phone', 'zip', 'city', 'region', 'country'],
        'Property Details': ['property_type', 'square_footage', 'bedrooms', 'bathrooms', 'year_built'],
        'Service Needs': ['needs', 'clear_out', 'timeline'],
        'Item Assessment': ['high_value', 'oversized'],
        'Condition': ['fullness', 'access'],
        'Geolocation': ['latitude', 'longitude', 'ip', 'isp'],
        'Device Info': ['device', 'user_agent'],
        'Lead Status': ['status', 'created_at', 'professional_id'],
      };

      let html = '';
      Object.entries(sections).forEach(([sectionTitle, fields]) => {
        let sectionContent = '';
        fields.forEach(field => {
          if (lead[field] !== null && lead[field] !== undefined && lead[field] !== '') {
            const value = Array.isArray(lead[field]) ? lead[field].join(', ') : String(lead[field]);
            const label = field.replace(/_/g, ' ').charAt(0).toUpperCase() + field.replace(/_/g, ' ').slice(1);
            sectionContent += `<div class="field"><div class="field-label">${label}</div><div class="field-value">${value}</div></div>`;
          }
        });
        if (sectionContent) {
          html += `<div class="detail-section"><h3>${sectionTitle}</h3>${sectionContent}</div>`;
        }
      });

      document.getElementById('modal-details').innerHTML = html;
      document.getElementById('detail-modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('detail-modal').classList.remove('active');
    }

    function filterLeads() {
      const search = document.getElementById('search-box').value.toLowerCase();
      const statusFilter = document.getElementById('status-filter').value;

      let filtered = allLeads.filter(lead => {
        const matchesSearch = !search || 
          (lead.customer_name?.toLowerCase().includes(search)) ||
          (lead.customer_email?.toLowerCase().includes(search)) ||
          (lead.customer_phone?.toLowerCase().includes(search));
        
        const matchesStatus = !statusFilter || (lead.status === statusFilter);
        
        return matchesSearch && matchesStatus;
      });

      renderTable(filtered);
    }

    function updateStats(leads) {
      document.getElementById('stat-total').textContent = leads.length;
      document.getElementById('stat-open').textContent = leads.filter(l => l.status === 'open').length;
      document.getElementById('stat-quoted').textContent = leads.filter(l => l.status === 'quoted').length;
      document.getElementById('stat-closed').textContent = leads.filter(l => l.status === 'closed').length;
    }

    function showDashboard() {
      document.getElementById('login-screen').classList.add('login-hidden');
      document.getElementById('dashboard-screen').classList.remove('dashboard-hidden');
    }

    function showLogin() {
      document.getElementById('login-screen').classList.remove('login-hidden');
      document.getElementById('dashboard-screen').classList.add('dashboard-hidden');
    }

    function handleLogout() {
      localStorage.removeItem('admin_session');
      showLogin();
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
    }

    window.addEventListener('DOMContentLoaded', () => {
      if (sessionToken) {
        showDashboard();
        loadLeads();
      } else {
        showLogin();
      }
    });

    document.getElementById('detail-modal').addEventListener('click', (e) => {
      if (e.target.id === 'detail-modal') closeModal();
    });
  </script>
</body>
</html>



